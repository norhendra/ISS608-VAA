---
title: "Investment vis"
author: "Nor Hendra"
format:
  dashboard:
    theme: zephyr
execute: 
  echo: false
editor: visual
---

<!----- shrink KPI boxes --->
```{=html}
<style>
/* only value-boxes inside .kpi-row */
.kpi-row .value-box {
  padding: 0.5rem 0.8rem;      /* default is ~1.5rem */
}
.kpi-row .value-box .title {
  font-size: 0.95rem;          /* default ~1.2rem */
}
.kpi-row .value-box .value {
  font-size: 2rem;             /* default ~3.5rem */
  line-height: 1.1;
}
</style>
```

```{r}
pacman::p_load(tidyverse, tidyquant, timetk, plotly, glue)
```

```{r}
SGStock <- read_csv("data/SGStock.csv")

daily_prices <- SGStock %>% 
  select(Symbol) %>% 
  tq_get(get  = "stock.prices",
         from = "2025-01-01",
         to   = Sys.Date()) %>% 
  left_join(SGStock)

start_date <- min(daily_prices$date, na.rm = TRUE)
end_date   <- max(daily_prices$date, na.rm = TRUE)
```

# DBS

## Key Metrics {.row .kpi-row}

```{r}
daily_summary <- daily_prices %>% 
  filter(Symbol == "D05.SI", date == end_date)
```

```{r}
#| content: valuebox
#| title: "Opening Price"
list(color = "primary", value = daily_summary$open)
```

```{r}
#| content: valuebox
#| title: "Closing Price"
list(color = "primary", value = daily_summary$close)
```

```{r}
#| content: valuebox
#| title: "Daily High"
list(color = "primary", value = daily_summary$high)
```

## Price Control Chart {.row}

```{r}
df <- daily_prices %>% 
  filter(Name == "DBS Group")

mean_close <- mean(df$close, na.rm = TRUE)
sd_close   <- sd(df$close,   na.rm = TRUE)
ucl <- mean_close + sd_close
lcl <- mean_close - sd_close

df <- df %>% 
  mutate(
    flag = case_when(
      close > ucl ~ "Above UCL",
      close < lcl ~ "Below LCL",
      TRUE        ~ "Within Limits")
  )

mean_lbl <- glue("Mean: {round(mean_close, 2)}")
ucl_lbl  <- glue("UCL:  {round(ucl,        2)}")
lcl_lbl  <- glue("LCL:  {round(lcl,        2)}")

dynamic_title <- glue(
  "DBS Stock Prices from {format(start_date, '%-d %B %Y')} ",
  "to {format(end_date,   '%-d %B %Y')}"
)
```

```{r}
p <- ggplot(df, aes(date, close)) +
  geom_line(color = "steelblue") +
  geom_hline(yintercept = mean_close, linetype = "dashed", colour = "grey30", size = 0.5) +
  geom_hline(yintercept = c(ucl, lcl), linetype = "dotted", colour = "red", size = 0.5) +
  geom_point(aes(color = flag), size = 1) +
  annotate("text", x = min(df$date), y = ucl  + 0.3, label = ucl_lbl,  hjust = 0, colour = "red", size = 3.5) +
  annotate("text", x = min(df$date), y = lcl  + 0.3, label = lcl_lbl,  hjust = 0, colour = "red", size = 3.5) +
  annotate("text", x = min(df$date), y = mean_close + 0.3, label = mean_lbl, hjust = 0, colour = "darkgreen", size = 3.5) +
  scale_color_manual(values = c("Above UCL" = "red", "Below LCL" = "red", "Within Limits" = "steelblue")) +
  scale_x_date(date_breaks = "1 month", date_labels = "%b %Y") +
  labs(title = dynamic_title, y = "Closing Price", x = NULL, colour = "flag") +
  theme_classic()

ggplotly(p)
```

# OCBC

# UOB

# SingTel

# SIA

# CapitaLand Mall Trust
